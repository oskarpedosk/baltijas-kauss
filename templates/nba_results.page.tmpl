{{template "base" .}}

{{define "content"}}
<div class="container p-3">
    <div id="standings">
        <div id="standingsreload" class="row align-items-md-stretch mb-4">
            <div class="col-md-12">
                <div class="h-100 p-5 rounded-3 bg-light border border-dark border-1">
                    <table class="table text-center">
                        <thead>
                            <tr>
                                <th scope="col"></th>
                                <th scope="col"></th>
                                <th scope="col">P</th>
                                <th scope="col">W</th>
                                <th scope="col">L</th>
                                <th scope="col">WIN%</th>
                                <th scope="col">HOME</th>
                                <th scope="col">ROAD</th>
                                <th scope="col">LAST 5</th>
                                <th scope="col">STRK</th>
                                <th scope="col">FOR</th>
                                <th scope="col">AGT</th>
                                <th scope="col">+-</th>
                                <th scope="col">FA</th>
                                <th scope="col">AA</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range $index, $standings := index .Data "standings"}}
                                    <tr>
                                        <th scope="row">{{add $index 1}}</th>
                                        <td class="text-start">
                                            {{range $teamInfo := index $.Data "teams"}}
                                                {{if eq $standings.TeamID $teamInfo.TeamID.Int64}}
                                                    {{$teamInfo.Name}}
                                                {{end}}
                                            {{end}}
                                        </td>
                                        <td style="font-variant-numeric: tabular-nums;">{{$standings.Played}}</td>
                                        <td style="font-variant-numeric: tabular-nums;">{{$standings.TotalWins}}</td>
                                        <td style="font-variant-numeric: tabular-nums;">{{$standings.TotalLosses}}</td>
                                        <td style="font-variant-numeric: tabular-nums;">
                                            {{if eq $standings.WinPercentage 1000}}
                                                1.000
                                            {{else}}
                                                .{{if lt $standings.WinPercentage 100}}0{{if eq $standings.WinPercentage 0}}0{{end}}{{end}}{{$standings.WinPercentage}}{{end}}</td>
                                        <td style="font-variant-numeric: tabular-nums;">{{$standings.HomeWins}}-{{$standings.HomeLosses}}</td>
                                        <td style="font-variant-numeric: tabular-nums;">{{$standings.AwayWins}}-{{$standings.AwayLosses}}</td>
                                        <td>
                                            <div style="margin: 0 auto;">
                                                {{range $lastFive := $standings.LastFive}}
                                                    {{if eq $lastFive "W"}}
                                                        <div class="dot bg-success"></div>
                                                    {{end}}
                                                    {{if eq $lastFive "L"}}
                                                        <div class="dot bg-danger"></div>
                                                    {{end}}
                                                    {{if eq $lastFive ""}}
                                                        <div class="dot bg-secondary"></div>
                                                    {{end}}
                                                {{end}}
                                            </div>
                                        </td>
                                        <td style="font-variant-numeric: tabular-nums;">
                                            {{if ne $standings.Streak ""}}
                                                {{$standings.StreakCount}} {{$standings.Streak}}
                                            {{end}}
                                        </td>
                                        <td style="font-variant-numeric: tabular-nums;">{{$standings.BasketsFor}}</td>
                                        <td style="font-variant-numeric: tabular-nums;">{{$standings.BasketsAgainst}}</td>
                                        <td>{{$standings.BasketsSum}}</td>
                                        <td style="font-variant-numeric: tabular-nums;">{{$standings.ForAvg}}</td>
                                        <td style="font-variant-numeric: tabular-nums;">{{$standings.AgainstAvg}}</td>
                                    </tr>

                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <div id="results">
        <div id="resultsreload" class="row align-items-md-stretch">
            <div class="col-md-12">
                <div class="p-5 bg-light border border-dark rounded-3">

                    {{$res := index .Data "result"}}

                    <form action="/nba/results" method="post" class="row justify-content-center" novalidate>
                        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                        <div class="col-md-2"></div>
                        <div class="col-md-3">
                            <select class="form-select {{with .Form.Errors.Get "home_team"}} is-invalid {{end}}" aria-label="Home team" name="home_team" required>
                                <option selected disabled value="">Home team</option>
                                {{range $teamInfo := index $.Data "teams"}}
                                    <option value="{{$teamInfo.TeamID.Int64}}">{{$teamInfo.Name}}</option>
                                {{end}}
                            </select>
                            {{with .Form.Errors.Get "home_team"}}
                            <label class="text-danger">{{.}}</label>
                            {{end}}
                        </div>

                        <div class="col-md-1">
                            <label for="home_score" class="visually-hidden">Home score</label>
                            <input type="number" min="0" class="form-control {{with .Form.Errors.Get "home_score"}} is-invalid {{end}}" name="home_score" placeholder="Score" value="{{$res.HomeScore}}"
                                required>
                            {{with .Form.Errors.Get "home_score"}}
                            <label class="text-danger">{{.}}</label>
                            {{end}}
                        </div>

                        <div class="col-md-1">
                            <label for="away_score" class="visually-hidden">Away score</label>
                            <input type="number" min="0" class="form-control {{with .Form.Errors.Get "away_score"}} is-invalid {{end}}" name="away_score" placeholder="Score" value="{{$res.AwayScore}}"
                                required>
                            {{with .Form.Errors.Get "away_score"}}
                            <label class="text-danger">{{.}}</label>
                            {{end}}
                        </div>

                        <div class="col-md-3">
                            <select class="form-select {{with .Form.Errors.Get "away_team"}} is-invalid {{end}}" aria-label="Away team" name="away_team" required>
                                <option selected disabled value="">Away team</option>
                                {{range $teamInfo := index $.Data "teams"}}
                                    <option value="{{$teamInfo.TeamID.Int64}}">{{$teamInfo.Name}}</option>
                                {{end}}
                            </select>
                            {{with .Form.Errors.Get "away_team"}}
                            <label class="text-danger">{{.}}</label>
                            {{end}}
                        </div>

                        <div class="col-md-2">
                            <button class="btn btn-outline-dark" type="submit">Add game</button>
                        </div>

                    </form>


                        {{range $index2, $results := index $.Data "last_results"}}
                        <hr class="{{if eq $index2 0}}mt-5{{end}} mb-4">
                        <div class="row text-center justify-content-center align-items-center">
                            <div class="col-md-2">

                            </div>
                            <div class="col-md-3 text-end">
                                    {{range $teamInfo := index $.Data "teams"}}
                                        {{if eq $results.HomeTeam $teamInfo.TeamID.Int64}}
                                        <p class="mb-0 p-2 fw-semibold badge {{if eq $teamInfo.DarkText "true"}}text-dark{{end}}" 
                                        style="font-size: 16px; text-transform:uppercase; background-image: linear-gradient(90deg, {{$teamInfo.Color1}}, {{$teamInfo.Color2}}); display:inline-block; width: 100%">
                                        {{$teamInfo.Name}}
                                        </p>
                                        {{end}}
                                    {{end}}

                            </div>
                            <div class="col-md-1">
                                <p class="mb-0 p-2 bg-white badge border text-dark {{if lt $results.HomeScore $results.AwayScore}}fw-normal{{end}}" style="font-size: 18px; width: 100%;">{{$results.HomeScore}}</p>
                            </div>
                            <div class="col-md-1">
                                
                                <p class="mb-0 p-2 bg-white badge border text-dark {{if lt $results.AwayScore $results.HomeScore}}fw-normal{{end}}" style="font-size: 18px; width: 100%;">{{$results.AwayScore}}</p>
                            </div>
                            <div class="col-md-3 text-start">

                                    {{range $teamInfo := index $.Data "teams"}}
                                        {{if eq $results.AwayTeam $teamInfo.TeamID.Int64}}
                                        <p class="mb-0 p-2 fw-semibold badge {{if eq $teamInfo.DarkText "true"}}text-dark{{end}}" 
                                        style="font-size: 16px; text-transform:uppercase; background-image: linear-gradient(90deg, {{$teamInfo.Color1}}, {{$teamInfo.Color2}}); display:inline-block; width: 100%">
                                        {{$teamInfo.Name}}
                                        </p>
                                        {{end}}
                                    {{end}}

                            </div>
                            <div class="col-md-2 d-flex justify-content-end pe-4">
                                <div class="btn-link text-decoration-none" class="dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    EDIT
                                </div>
                                    <div class="dropdown-menu my-3 col-md-3 p-4 bg-light border border-dark" style="box-shadow: rgba(50, 50, 93, 0.25) 0px 30px 60px -12px, rgba(0, 0, 0, 0.5) 0px 18px 36px -18px;">
                                        <form id="edit_result" action="/nba/results" method="post">
                                            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                                            <input type="hidden" name="timestamp" value="{{$results.Time}}">
                                            <input type="hidden" name="edit_result" value="true">
                                                <div class="row mb-4">
                                                    <div class="col-md-8">
                                                        <select id="home_team{{$index2}}" class="form-select" aria-label="Home team" name="home_team" required>
                                                            {{range $teamInfo := index $.Data "teams"}}
                                                                <option {{if eq $results.HomeTeam $teamInfo.TeamID.Int64}}selected{{end}} value="{{$teamInfo.TeamID.Int64}}">{{$teamInfo.Name}}</option>
                                                            {{end}}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label for="home_score" class="visually-hidden">Home score</label>
                                                        <input id="home_score{{$index2}}" type="number" min="0" class="form-control" name="home_score" placeholder="Score" value="{{$results.HomeScore}}"
                                                            required>
                                                    </div>
                                                </div>

                                                <div class="row mb-4">
                                                    <div class="col-md-8">
                                                        <select id="away_team{{$index2}}" class="form-select" aria-label="Away team" name="away_team" required>
                                                            {{range $teamInfo := index $.Data "teams"}}
                                                                <option {{if eq $results.AwayTeam $teamInfo.TeamID.Int64}}selected{{end}} value="{{$teamInfo.TeamID.Int64}}">{{$teamInfo.Name}}</option>
                                                            {{end}}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label for="away_score" class="visually-hidden">Away score</label>
                                                        <input id="away_score{{$index2}}" type="number" min="0" class="form-control" name="away_score" placeholder="Score" value="{{$results.AwayScore}}"
                                                            required>
                                                    </div>
                                                </div>

                                        </form>
                                
                                                <div class="row justify-content-center">
                                                    <div class="col-md-6">
                                                        <button class="btn btn-outline-dark" onclick="updateResult('{{$index2}}', '{{$results.Time}}')" style="width: 100%;">Update</button>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <button class="btn btn-outline-dark" onclick="deleteResult('{{$results.Time}}')" style="width: 100%;">Delete</button>
                                                    </div>
                                                </div>
                                        
                                    </div>
                            </div>
                        </div>
                        <div class="row text-center">
                            <p class="mt-1 mb-1" style="font-size: 12px;">{{$results.TimeString}}</p>
                        </div>
                    {{end}}
                </div>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "js"}}


<script>
    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (() => {
        'use strict'

        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        const forms = document.querySelectorAll('.needs-validation')

        // Loop over them and prevent submission
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }

                form.classList.add('was-validated')
            }, false)
        })
    })()

    function updateResult(index, timestamp) {
        var home_team_id = document.getElementById('home_team' + index).value;
        var home_score = document.getElementById('home_score' + index).value;
        var away_score = document.getElementById('away_score' + index).value;
        var away_team_id = document.getElementById('away_team' + index).value;
        console.log(home_team_id)
        console.log(home_score)
        console.log(away_score)
        console.log(away_team_id)
        $.ajax({
            type: 'GET',
            dataType: 'html',
            data : {
                action: "update",
                home_team_id: home_team_id,
                home_score: home_score,
                away_score: away_score,
                away_team_id: away_team_id,
                timestamp: timestamp,
            },
            success: function(data) {
                console.log("success");
                $( '#results' ).load(window.location.href + ' #resultsreload' );
                $( '#standings' ).load(window.location.href + ' #standingsreload' );
            }
        });
    }

    function deleteResult(timestamp) {
        console.log("timestamp = ", timestamp);
        $.ajax({
            type: 'GET',
            dataType: 'html',
            data : {
                action: "delete",
                timestamp: timestamp,
            },
            success: function(data) {
                console.log("success");
                $( '#results' ).load(window.location.href + ' #resultsreload' );
                $( '#standings' ).load(window.location.href + ' #standingsreload' );
            }
        });
    }

</script>

{{end}}